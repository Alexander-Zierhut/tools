version: 2.1
description: "Tools for running pytest"

jobs:
  pytest:
    description: |
      Runs pytest against the current repo.
    docker:
      - image: python:<<parameters.python_version>>
    parameters:
      args:
        default: ''
        description: |
          Arguments to pass to pytest.
        type: string
      cache_prefix:
        default: ''
        description: |
          Optional cache prefix to be used on CircleCI. Can be used for cache busting or to ensure multiple jobs use different caches.
        type: string
      install_args:
        default: pytest
        description: |
          Arguments to `pip install` command.
        type: string
      python_version:
        default: 3.7.2
        description: |
          The python version used to run pytest.
        type: string
    steps:
      - checkout
      - restore_cache:
          keys:
            - cache-pip-<<parameters.python_version>>-<<parameters.cache_prefix>>-{{ .Branch }}-{{ .Revision }}
            - cache-pip-<<parameters.python_version>>-<<parameters.cache_prefix>>-{{ .Branch }}-
            - cache-pip-<<parameters.python_version>>-<<parameters.cache_prefix>>-
      - run: python -m pip install <<parameters.install_args>>
      - save_cache:
          key: cache-pip-<<parameters.python_version>>-<<parameters.cache_prefix>>-{{ .Branch }}-{{ .Revision }}
          paths:
            - ~/.cache/pip
      - run: python -m pytest <<parameters.args>>
